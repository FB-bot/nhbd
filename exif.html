<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXIF Viewer | NHBD</title>
    <link rel="icon" type="image/png" href="img/logo.png">
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css">
    <script type='text/javascript' src='//pl27277581.profitableratecpm.com/aa/02/e4/aa02e48c3c019548e529e843a835a602.js'></script>
    <style>
        :root {
            --primary-bg: #121212;
            --secondary-bg: #1e1e1e;
            --accent-color: #FFD700;
            --accent-dark: #b39700;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --border-color: #333;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--secondary-bg);
            border-bottom: 2px solid var(--accent-color);
            padding: 20px 0;
            margin-bottom: 30px;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        h1 {
            color: var(--accent-color);
            margin: 0;
            font-size: 1.8rem;
        }
        
        .nav-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom: 2px solid var(--accent-color);
            color: var(--accent-color);
        }
        
        .tab:hover:not(.active) {
            border-bottom: 2px solid var(--accent-dark);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed var(--accent-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area:hover {
            background-color: rgba(255, 215, 0, 0.05);
        }
        
        .upload-area.highlight {
            background-color: rgba(255, 215, 0, 0.1);
        }
        
        .file-input {
            display: none;
        }
        
        .btn {
            background-color: var(--accent-color);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn:hover {
            background-color: #ffdf40;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.2);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-secondary {
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: #2a2a2a;
            transform: none;
            box-shadow: none;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .preview-container {
                grid-template-columns: 1fr;
            }
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            object-fit: contain;
            background: repeating-conic-gradient(#1a1a1a 0% 25%, #222 0% 50%) 50% / 20px 20px;
        }
        
        .metadata-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .metadata-card {
            background-color: var(--secondary-bg);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .metadata-card h3 {
            margin-top: 0;
            color: var(--accent-color);
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .metadata-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 1px dashed var(--border-color);
        }
        
        .metadata-label {
            font-weight: 600;
            color: var(--accent-color);
        }
        
        .metadata-value {
            text-align: right;
            word-break: break-word;
        }
        
        .map-container {
            height: 300px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 20px;
        }
        
        .batch-results {
            margin-top: 20px;
        }
        
        .batch-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            overflow-x: auto;
            display: block;
        }
        
        .batch-table th, .batch-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .batch-table th {
            background-color: var(--secondary-bg);
            color: var(--accent-color);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .batch-table tr:hover {
            background-color: rgba(255, 215, 0, 0.05);
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted var(--text-muted);
            cursor: help;
            margin-left: 5px;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .progress-bar {
            width: 100%;
            background-color: var(--secondary-bg);
            border-radius: 4px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress {
            height: 10px;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s;
        }
        
        .status-message {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        .status-success {
            background-color: rgba(40, 167, 69, 0.2);
            border-left: 4px solid var(--success-color);
        }
        
        .status-error {
            background-color: rgba(220, 53, 69, 0.2);
            border-left: 4px solid var(--error-color);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .hidden {
            display: none;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--text-muted);
            font-size: 0.9rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* Animation for loading */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .action-buttons {
                justify-content: center;
            }
            
            .metadata-item {
                flex-direction: column;
                gap: 5px;
            }
            
            .metadata-label, .metadata-value {
                text-align: left;
            }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dark);
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>EXIF Viewer</h1>
            <div class="action-buttons">
                <button id="exportBtn" class="btn-secondary" disabled>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
                <button id="settingsBtn" class="btn-secondary">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    Settings
                </button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <div class="nav-tabs">
            <div class="tab active" data-tab="single">Single Image</div>
            <div class="tab" data-tab="batch">Batch Analysis</div>
            <div class="tab" data-tab="compare">Compare</div>
            <div class="tab" data-tab="tools">Tools</div>
        </div>
        
        <!-- Single Image Tab -->
        <div id="single" class="tab-content active">
            <div class="upload-area" id="dropZone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <h2>Upload Image to Analyze</h2>
                <p>Drag & drop your photo here or click to browse</p>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                <button id="uploadBtn" class="btn">Select Image</button>
                <div class="progress-bar" id="uploadProgress">
                    <div class="progress" id="progressBar"></div>
                </div>
                <div class="status-message" id="statusMessage"></div>
            </div>
            
            <div id="analysisSection" class="hidden">
                <div class="preview-container">
                    <div>
                        <h3>Image Preview</h3>
                        <img id="imagePreview" class="image-preview" src="#" alt="Preview">
                        <div class="action-buttons">
                            <button id="stripMetadataBtn" class="btn-secondary">Strip Metadata</button>
                            <button id="downloadBtn" class="btn">Download</button>
                        </div>
                    </div>
                    <div>
                        <h3>Camera Settings Visualization</h3>
                        <div class="chart-container">
                            <canvas id="settingsChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <h3>Metadata Analysis</h3>
                <div class="metadata-grid" id="metadataOutput">
                    <!-- Metadata cards will be inserted here -->
                </div>
                
                <div id="locationSection" class="hidden">
                    <h3>Location Data</h3>
                    <div class="map-container" id="map"></div>
                    <div class="metadata-item">
                        <span class="metadata-label">Address:</span>
                        <span class="metadata-value" id="locationAddress">Loading address...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Batch Analysis Tab -->
        <div id="batch" class="tab-content">
            <div class="upload-area" id="batchDropZone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                    <path d="M14 15H10"></path>
                    <path d="M12 15v4"></path>
                </svg>
                <h2>Upload Multiple Images</h2>
                <p>Drag & drop photos here or click to browse (max 20 files)</p>
                <input type="file" id="batchFileInput" class="file-input" accept="image/*" multiple>
                <button id="batchUploadBtn" class="btn">Select Images</button>
                <div class="progress-bar" id="batchUploadProgress">
                    <div class="progress" id="batchProgressBar"></div>
                </div>
                <div class="status-message" id="batchStatusMessage"></div>
            </div>
            
            <div id="batchResults" class="batch-results hidden">
                <h3>Batch Analysis Results</h3>
                <div class="action-buttons">
                    <button id="exportBatchBtn" class="btn">Export as CSV</button>
                    <button id="analyzeBatchBtn" class="btn-secondary">Show Statistics</button>
                </div>
                <div class="chart-container hidden" id="batchChartContainer">
                    <canvas id="batchChart"></canvas>
                </div>
                <div class="table-responsive">
                    <table class="batch-table">
                        <thead>
                            <tr>
                                <th>Filename</th>
                                <th>Camera</th>
                                <th>Date</th>
                                <th>Settings</th>
                                <th>Location</th>
                            </tr>
                        </thead>
                        <tbody id="batchResultsBody">
                            <!-- Batch results will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Compare Tab -->
        <div id="compare" class="tab-content">
            <div class="upload-area" id="compareDropZone">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="20" x2="18" y2="10"></line>
                    <line x1="12" y1="20" x2="12" y2="4"></line>
                    <line x1="6" y1="20" x2="6" y2="14"></line>
                </svg>
                <h2>Compare Images</h2>
                <p>Upload 2-4 images to compare their metadata</p>
                <input type="file" id="compareFileInput" class="file-input" accept="image/*" multiple>
                <button id="compareUploadBtn" class="btn">Select Images</button>
                <div class="progress-bar" id="compareUploadProgress">
                    <div class="progress" id="compareProgressBar"></div>
                </div>
                <div class="status-message" id="compareStatusMessage"></div>
            </div>
            
            <div id="compareResults" class="hidden">
                <h3>Comparison Results</h3>
                <div class="action-buttons">
                    <button id="exportCompareBtn" class="btn">Export Comparison</button>
                </div>
                <div class="chart-container">
                    <canvas id="compareChart"></canvas>
                </div>
                <div class="metadata-grid" id="compareOutput">
                    <!-- Comparison results will be inserted here -->
                </div>
            </div>
        </div>
        
        <!-- Tools Tab -->
        <div id="tools" class="tab-content">
            <h2>Metadata Tools</h2>
            <div class="metadata-grid">
                <div class="metadata-card">
                    <h3>Metadata Cleaner</h3>
                    <p>Remove all metadata from your images to protect privacy.</p>
                    <input type="file" id="cleanerFileInput" class="file-input" accept="image/*">
                    <button id="cleanerBtn" class="btn">Clean Images</button>
                    <div class="status-message" id="cleanerStatusMessage"></div>
                </div>
                
                <div class="metadata-card">
                    <h3>Metadata Editor</h3>
                    <p>Edit specific metadata fields in your images.</p>
                    <input type="file" id="editorFileInput" class="file-input" accept="image/*">
                    <button id="editorBtn" class="btn" disabled>Coming Soon</button>
                </div>
                
                <div class="metadata-card">
                    <h3>GPS Coordinates Converter</h3>
                    <div class="metadata-item">
                        <span class="metadata-label">Format:</span>
                        <select id="gpsFormat" class="btn-secondary">
                            <option value="decimal">Decimal Degrees</option>
                            <option value="dms">Degrees, Minutes, Seconds</option>
                            <option value="utm">UTM</option>
                        </select>
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Latitude:</span>
                        <input type="text" id="gpsLat" class="btn-secondary" placeholder="e.g., 40.7128">
                    </div>
                    <div class="metadata-item">
                        <span class="metadata-label">Longitude:</span>
                        <input type="text" id="gpsLon" class="btn-secondary" placeholder="e.g., -74.0060">
                    </div>
                    <button id="convertBtn" class="btn">Convert</button>
                    <div id="gpsResult" class="metadata-item hidden">
                        <span class="metadata-label">Result:</span>
                        <span class="metadata-value" id="gpsResultValue"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; Sajjad Hosen</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab switching functionality
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Initialize variables
            let currentImage = null;
            let map = null;
            let marker = null;
            let settingsChart = null;
            let batchChart = null;
            let compareChart = null;
            let batchFiles = [];
            let compareFiles = [];
            
            // Single image upload functionality
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropZone = document.getElementById('dropZone');
            const uploadProgress = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const statusMessage = document.getElementById('statusMessage');
            const analysisSection = document.getElementById('analysisSection');
            const imagePreview = document.getElementById('imagePreview');
            const metadataOutput = document.getElementById('metadataOutput');
            const locationSection = document.getElementById('locationSection');
            const locationAddress = document.getElementById('locationAddress');
            const stripMetadataBtn = document.getElementById('stripMetadataBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const exportBtn = document.getElementById('exportBtn');
            
            // Batch upload functionality
            const batchFileInput = document.getElementById('batchFileInput');
            const batchUploadBtn = document.getElementById('batchUploadBtn');
            const batchDropZone = document.getElementById('batchDropZone');
            const batchUploadProgress = document.getElementById('batchUploadProgress');
            const batchProgressBar = document.getElementById('batchProgressBar');
            const batchStatusMessage = document.getElementById('batchStatusMessage');
            const batchResults = document.getElementById('batchResults');
            const batchResultsBody = document.getElementById('batchResultsBody');
            const exportBatchBtn = document.getElementById('exportBatchBtn');
            const analyzeBatchBtn = document.getElementById('analyzeBatchBtn');
            const batchChartContainer = document.getElementById('batchChartContainer');
            
            // Compare functionality
            const compareFileInput = document.getElementById('compareFileInput');
            const compareUploadBtn = document.getElementById('compareUploadBtn');
            const compareDropZone = document.getElementById('compareDropZone');
            const compareUploadProgress = document.getElementById('compareUploadProgress');
            const compareProgressBar = document.getElementById('compareProgressBar');
            const compareStatusMessage = document.getElementById('compareStatusMessage');
            const compareResults = document.getElementById('compareResults');
            const compareOutput = document.getElementById('compareOutput');
            const exportCompareBtn = document.getElementById('exportCompareBtn');
            
            // Tools functionality
            const cleanerFileInput = document.getElementById('cleanerFileInput');
            const cleanerBtn = document.getElementById('cleanerBtn');
            const cleanerStatusMessage = document.getElementById('cleanerStatusMessage');
            const convertBtn = document.getElementById('convertBtn');
            const gpsResult = document.getElementById('gpsResult');
            const gpsResultValue = document.getElementById('gpsResultValue');
            
            // Event listeners for single image upload
            uploadBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // Drag and drop for single image
            setupDropZone(dropZone, fileInput);
            
            // Event listeners for batch upload
            batchUploadBtn.addEventListener('click', () => batchFileInput.click());
            batchFileInput.addEventListener('change', handleBatchFileSelect);
            
            // Drag and drop for batch upload
            setupDropZone(batchDropZone, batchFileInput);
            
            // Event listeners for compare upload
            compareUploadBtn.addEventListener('click', () => compareFileInput.click());
            compareFileInput.addEventListener('change', handleCompareFileSelect);
            
            // Drag and drop for compare upload
            setupDropZone(compareDropZone, compareFileInput);
            
            // Tools event listeners
            cleanerBtn.addEventListener('click', handleCleanerUpload);
            cleanerFileInput.addEventListener('change', function() {
                cleanerBtn.disabled = !this.files || this.files.length === 0;
            });
            
            convertBtn.addEventListener('click', handleGpsConversion);
            
            // Export buttons
            exportBtn.addEventListener('click', exportMetadata);
            exportBatchBtn.addEventListener('click', exportBatchMetadata);
            exportCompareBtn.addEventListener('click', exportComparison);
            
            // Other buttons
            stripMetadataBtn.addEventListener('click', stripMetadata);
            downloadBtn.addEventListener('click', downloadImage);
            analyzeBatchBtn.addEventListener('click', showBatchStatistics);
            
            // Initialize map (hidden by default)
            initMap();
            
            function setupDropZone(dropZoneElement, inputElement) {
                dropZoneElement.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZoneElement.classList.add('highlight');
                });
                
                dropZoneElement.addEventListener('dragleave', () => {
                    dropZoneElement.classList.remove('highlight');
                });
                
                dropZoneElement.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZoneElement.classList.remove('highlight');
                    
                    if (e.dataTransfer.files.length) {
                        inputElement.files = e.dataTransfer.files;
                        
                        if (inputElement === fileInput) {
                            handleFileSelect({ target: inputElement });
                        } else if (inputElement === batchFileInput) {
                            handleBatchFileSelect({ target: inputElement });
                        } else if (inputElement === compareFileInput) {
                            handleCompareFileSelect({ target: inputElement });
                        } else if (inputElement === cleanerFileInput) {
                            cleanerBtn.disabled = false;
                        }
                    }
                });
            }
            
            function handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Check if file is an image
                if (!file.type.match('image.*')) {
                    statusMessage.textContent = "Please select an image file (JPEG, PNG, etc.)";
                    statusMessage.className = "status-message status-error";
                    statusMessage.style.display = "block";
                    return;
                }
                
                currentImage = file;
                
                // Show upload progress
                uploadProgress.style.display = 'block';
                progressBar.style.width = '0%';
                statusMessage.style.display = 'none';
                
                // Simulate upload progress (in a real app, this would be actual upload progress)
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    
                    if (progress >= 100) {
                        clearInterval(progressInterval);
                        processImage(file);
                    }
                }, 50);
            }
            
            function processImage(file) {
                const reader = new FileReader();
                
                reader.onloadstart = function() {
                    statusMessage.textContent = "Reading image data...";
                    statusMessage.className = "status-message";
                    statusMessage.style.display = "block";
                };
                
                reader.onprogress = function(e) {
                    if (e.lengthComputable) {
                        const percentLoaded = Math.round((e.loaded / e.total) * 100);
                        progressBar.style.width = `${percentLoaded}%`;
                    }
                };
                
                reader.onload = function(e) {
                    // Display preview
                    imagePreview.src = e.target.result;
                    
                    // Hide progress bar
                    uploadProgress.style.display = 'none';
                    
                    // Extract EXIF data
                    EXIF.getData(file, function() {
                        try {
                            const allMetaData = EXIF.getAllTags(this);
                            displayMetadata(allMetaData);
                            
                            // Show success message
                            statusMessage.textContent = "Image processed successfully!";
                            statusMessage.className = "status-message status-success";
                            statusMessage.style.display = "block";
                            
                            // Show analysis section
                            analysisSection.classList.remove('hidden');
                            
                            // Enable export button
                            exportBtn.disabled = false;
                        } catch (error) {
                            console.error("Error processing EXIF data:", error);
                            statusMessage.textContent = "Error processing image metadata";
                            statusMessage.className = "status-message status-error";
                            statusMessage.style.display = "block";
                        }
                    });
                };
                
                reader.onerror = function() {
                    statusMessage.textContent = "Error reading file. Please try again.";
                    statusMessage.className = "status-message status-error";
                    statusMessage.style.display = "block";
                    progressBar.style.width = "0%";
                };
                
                reader.readAsDataURL(file);
            }
            
            function displayMetadata(metadata) {
                let html = '';
                
                // Camera Information Card
                html += `
                    <div class="metadata-card">
                        <h3>Camera Information</h3>
                        ${metadata.Make ? `<div class="metadata-item"><span class="metadata-label">Make:</span> <span class="metadata-value">${metadata.Make}</span></div>` : ''}
                        ${metadata.Model ? `<div class="metadata-item"><span class="metadata-label">Model:</span> <span class="metadata-value">${metadata.Model}</span></div>` : ''}
                        ${metadata.LensMake ? `<div class="metadata-item"><span class="metadata-label">Lens Make:</span> <span class="metadata-value">${metadata.LensMake}</span></div>` : ''}
                        ${metadata.LensModel ? `<div class="metadata-item"><span class="metadata-label">Lens Model:</span> <span class="metadata-value">${metadata.LensModel}</span></div>` : ''}
                        ${metadata.SerialNumber ? `<div class="metadata-item"><span class="metadata-label">Serial Number:</span> <span class="metadata-value">${metadata.SerialNumber}</span></div>` : ''}
                    </div>
                `;
                
                // Capture Settings Card
                html += `
                    <div class="metadata-card">
                        <h3>Capture Settings</h3>
                        ${metadata.ExposureTime ? `<div class="metadata-item"><span class="metadata-label">Exposure:</span> <span class="metadata-value">${formatExposureTime(metadata.ExposureTime)}</span></div>` : ''}
                        ${metadata.FNumber ? `<div class="metadata-item"><span class="metadata-label">Aperture:</span> <span class="metadata-value">f/${metadata.FNumber}</span></div>` : ''}
                        ${metadata.ISOSpeedRatings ? `<div class="metadata-item"><span class="metadata-label">ISO:</span> <span class="metadata-value">${metadata.ISOSpeedRatings}</span></div>` : ''}
                        ${metadata.FocalLength ? `<div class="metadata-item"><span class="metadata-label">Focal Length:</span> <span class="metadata-value">${metadata.FocalLength}mm</span></div>` : ''}
                        ${metadata.Flash ? `<div class="metadata-item"><span class="metadata-label">Flash:</span> <span class="metadata-value">${formatFlash(metadata.Flash)}</span></div>` : ''}
                        ${metadata.WhiteBalance ? `<div class="metadata-item"><span class="metadata-label">White Balance:</span> <span class="metadata-value">${formatWhiteBalance(metadata.WhiteBalance)}</span></div>` : ''}
                        ${metadata.MeteringMode ? `<div class="metadata-item"><span class="metadata-label">Metering Mode:</span> <span class="metadata-value">${formatMeteringMode(metadata.MeteringMode)}</span></div>` : ''}
                    </div>
                `;
                
                // Date & Location Card
                let dateLocationHtml = '';
                dateLocationHtml += metadata.DateTimeOriginal ? `<div class="metadata-item"><span class="metadata-label">Date Taken:</span> <span class="metadata-value">${formatExifDate(metadata.DateTimeOriginal)}</span></div>` : '';
                
                if (metadata.GPSLatitude && metadata.GPSLongitude) {
                    const lat = convertGPSToDecimal(metadata.GPSLatitude, metadata.GPSLatitudeRef);
                    const lon = convertGPSToDecimal(metadata.GPSLongitude, metadata.GPSLongitudeRef);
                    
                    dateLocationHtml += `
                        <div class="metadata-item"><span class="metadata-label">Coordinates:</span> 
                            <span class="metadata-value">
                                ${lat}° ${metadata.GPSLatitudeRef}, ${lon}° ${metadata.GPSLongitudeRef}
                                <span class="tooltip">ⓘ<span class="tooltiptext">Click on map to view location</span></span>
                            </span>
                        </div>
                    `;
                    
                    // Show location section and update map
                    locationSection.classList.remove('hidden');
                    updateMap(lat, lon);
                    
                    // Reverse geocode to get address
                    getAddressFromCoordinates(lat, lon);
                }
                
                html += `
                    <div class="metadata-card">
                        <h3>Date & Location</h3>
                        ${dateLocationHtml}
                    </div>
                `;
                
                // Software & Advanced Card
                html += `
                    <div class="metadata-card">
                        <h3>Software & Advanced</h3>
                        ${metadata.Software ? `<div class="metadata-item"><span class="metadata-label">Software:</span> <span class="metadata-value">${metadata.Software}</span></div>` : ''}
                        ${metadata.ModifyDate ? `<div class="metadata-item"><span class="metadata-label">Modified Date:</span> <span class="metadata-value">${formatExifDate(metadata.ModifyDate)}</span></div>` : ''}
                        ${metadata.Artist ? `<div class="metadata-item"><span class="metadata-label">Artist:</span> <span class="metadata-value">${metadata.Artist}</span></div>` : ''}
                        ${metadata.Copyright ? `<div class="metadata-item"><span class="metadata-label">Copyright:</span> <span class="metadata-value">${metadata.Copyright}</span></div>` : ''}
                        ${metadata.XResolution ? `<div class="metadata-item"><span class="metadata-label">X Resolution:</span> <span class="metadata-value">${metadata.XResolution} dpi</span></div>` : ''}
                        ${metadata.YResolution ? `<div class="metadata-item"><span class="metadata-label">Y Resolution:</span> <span class="metadata-value">${metadata.YResolution} dpi</span></div>` : ''}
                    </div>
                `;
                
                metadataOutput.innerHTML = html;
                
                // Create settings chart
                createSettingsChart(metadata);
            }
            
            function formatExposureTime(exposure) {
                if (!exposure) return 'N/A';
                
                // Format exposure time to be more readable
                if (exposure < 1) {
                    const numerator = 1;
                    const denominator = Math.round(1 / exposure);
                    return `${numerator}/${denominator}s`;
                }
                return `${exposure}s`;
            }
            
            function formatFlash(flashValue) {
                if (flashValue === undefined) return 'N/A';
                
                // Convert flash value to human-readable format
                const flashMap = {
                    0x0: 'No Flash',
                    0x1: 'Fired',
                    0x5: 'Fired, Return not detected',
                    0x7: 'Fired, Return detected',
                    0x8: 'On, Did not fire',
                    0x9: 'On, Fired',
                    0xD: 'On, Return not detected',
                    0xF: 'On, Return detected',
                    0x10: 'Off, Did not fire',
                    0x14: 'Off, Did not fire, Return not detected',
                    0x18: 'Auto, Did not fire',
                    0x19: 'Auto, Fired',
                    0x1D: 'Auto, Fired, Return not detected',
                    0x1F: 'Auto, Fired, Return detected',
                    0x20: 'No flash function',
                    0x41: 'Fired, Red-eye reduction',
                    0x45: 'Fired, Red-eye reduction, Return not detected',
                    0x47: 'Fired, Red-eye reduction, Return detected',
                    0x49: 'On, Red-eye reduction',
                    0x4D: 'On, Red-eye reduction, Return not detected',
                    0x4F: 'On, Red-eye reduction, Return detected',
                    0x59: 'On, Auto, Red-eye reduction',
                    0x5D: 'On, Auto, Red-eye reduction, Return not detected',
                    0x5F: 'On, Auto, Red-eye reduction, Return detected'
                };
                
                return flashMap[flashValue] || `Unknown (${flashValue})`;
            }
            
            function formatWhiteBalance(wbValue) {
                if (wbValue === undefined) return 'N/A';
                return wbValue == 1 ? 'Auto' : 'Manual';
            }
            
            function formatMeteringMode(mode) {
                if (mode === undefined) return 'N/A';
                
                const modes = {
                    0: 'Unknown',
                    1: 'Average',
                    2: 'Center-weighted average',
                    3: 'Spot',
                    4: 'Multi-spot',
                    5: 'Pattern',
                    6: 'Partial',
                    255: 'Other'
                };
                return modes[mode] || `Unknown (${mode})`;
            }
            
            function formatExifDate(exifDate) {
                if (!exifDate) return 'N/A';
                
                try {
                    // Format: "YYYY:MM:DD HH:MM:SS"
                    const [datePart, timePart] = exifDate.split(' ');
                    const [year, month, day] = datePart.split(':');
                    return `${day}/${month}/${year} ${timePart}`;
                } catch (e) {
                    return exifDate; // Return original if parsing fails
                }
            }
            
            function convertGPSToDecimal(gpsArray, ref) {
                if (!gpsArray || !ref) return '';
                
                try {
                    const degrees = gpsArray[0] || 0;
                    const minutes = gpsArray[1] || 0;
                    const seconds = gpsArray[2] || 0;
                    
                    let decimal = degrees + (minutes / 60) + (seconds / 3600);
                    if (ref === 'S' || ref === 'W') decimal = -decimal;
                    
                    return decimal.toFixed(6);
                } catch (e) {
                    console.error("Error converting GPS coordinates:", e);
                    return 'Error';
                }
            }
            
            function initMap() {
                try {
                    // Initialize map but keep it hidden until needed
                    map = L.map('map', {
                        zoomControl: false
                    }).setView([0, 0], 2);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(map);
                    
                    // Hide initially
                    document.getElementById('map').style.display = 'none';
                } catch (e) {
                    console.error("Error initializing map:", e);
                }
            }
            
            function updateMap(lat, lon) {
                try {
                    const mapElement = document.getElementById('map');
                    mapElement.style.display = 'block';
                    
                    if (marker) {
                        map.removeLayer(marker);
                    }
                    
                    map.setView([lat, lon], 13);
                    marker = L.marker([lat, lon]).addTo(map);
                    
                    // Add click event to open in Google Maps
                    marker.on('click', function() {
                        window.open(`https://www.google.com/maps?q=${lat},${lon}`, '_blank');
                    });
                } catch (e) {
                    console.error("Error updating map:", e);
                }
            }
            
            function getAddressFromCoordinates(lat, lon) {
                // In a real app, you would use a geocoding service like Nominatim or Google Maps Geocoding API
                // This is a simplified version that just shows the coordinates
                locationAddress.textContent = `${lat}° ${lon}°`;
                
                // Simulate API call delay
                setTimeout(() => {
                    locationAddress.textContent = "Approximate location (geocoding service not implemented in demo)";
                }, 1500);
            }
            
            function createSettingsChart(metadata) {
                try {
                    const ctx = document.getElementById('settingsChart').getContext('2d');
                    
                    if (settingsChart) {
                        settingsChart.destroy();
                    }
                    
                    const chartData = {
                        labels: ['Aperture', 'Shutter Speed', 'ISO', 'Focal Length'],
                        datasets: [{
                            label: 'Camera Settings',
                            data: [
                                metadata.FNumber || 0,
                                metadata.ExposureTime ? 1/metadata.ExposureTime : 0, // Convert to speed value
                                metadata.ISOSpeedRatings || 0,
                                metadata.FocalLength || 0
                            ],
                            backgroundColor: [
                                'rgba(255, 215, 0, 0.7)',
                                'rgba(255, 215, 0, 0.5)',
                                'rgba(255, 215, 0, 0.3)',
                                'rgba(255, 215, 0, 0.9)'
                            ],
                            borderColor: [
                                'rgba(255, 215, 0, 1)',
                                'rgba(255, 215, 0, 1)',
                                'rgba(255, 215, 0, 1)',
                                'rgba(255, 215, 0, 1)'
                            ],
                            borderWidth: 1
                        }]
                    };
                    
                    settingsChart = new Chart(ctx, {
                        type: 'radar',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    angleLines: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    },
                                    pointLabels: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    },
                                    ticks: {
                                        backdropColor: 'rgba(0, 0, 0, 0)',
                                        color: 'rgba(255, 255, 255, 0.5)',
                                        showLabelBackdrop: false
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error creating settings chart:", e);
                }
            }
            
            function exportMetadata() {
                if (!currentImage) return;
                
                EXIF.getData(currentImage, function() {
                    try {
                        const allMetaData = EXIF.getAllTags(this);
                        const jsonStr = JSON.stringify(allMetaData, null, 2);
                        
                        // Create download link
                        const blob = new Blob([jsonStr], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'metadata.json';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        
                        // Show success message
                        statusMessage.textContent = "Metadata exported successfully!";
                        statusMessage.className = "status-message status-success";
                        statusMessage.style.display = "block";
                    } catch (e) {
                        console.error("Error exporting metadata:", e);
                        statusMessage.textContent = "Error exporting metadata";
                        statusMessage.className = "status-message status-error";
                        statusMessage.style.display = "block";
                    }
                });
            }
            
            function stripMetadata() {
                if (!currentImage) return;
                
                statusMessage.textContent = "Stripping metadata...";
                statusMessage.className = "status-message";
                statusMessage.style.display = "block";
                
                try {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        // Update preview and current image
                        imagePreview.src = canvas.toDataURL('image/jpeg');
                        
                        // Create new file from canvas
                        canvas.toBlob(function(blob) {
                            const newFile = new File([blob], currentImage.name, { type: 'image/jpeg' });
                            currentImage = newFile;
                            
                            // Show success message
                            statusMessage.textContent = "Metadata stripped successfully!";
                            statusMessage.className = "status-message status-success";
                            statusMessage.style.display = "block";
                            
                            // Disable export button as metadata is now gone
                            exportBtn.disabled = true;
                        }, 'image/jpeg', 0.92);
                    };
                    
                    img.onerror = function() {
                        statusMessage.textContent = "Error processing image";
                        statusMessage.className = "status-message status-error";
                        statusMessage.style.display = "block";
                    };
                    
                    img.src = URL.createObjectURL(currentImage);
                } catch (e) {
                    console.error("Error stripping metadata:", e);
                    statusMessage.textContent = "Error stripping metadata";
                    statusMessage.className = "status-message status-error";
                    statusMessage.style.display = "block";
                }
            }
            
            function downloadImage() {
                if (!currentImage) return;
                
                try {
                    const a = document.createElement('a');
                    a.href = imagePreview.src;
                    a.download = currentImage.name || 'image.jpg';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    // Show success message
                    statusMessage.textContent = "Image downloaded!";
                    statusMessage.className = "status-message status-success";
                    statusMessage.style.display = "block";
                } catch (e) {
                    console.error("Error downloading image:", e);
                    statusMessage.textContent = "Error downloading image";
                    statusMessage.className = "status-message status-error";
                    statusMessage.style.display = "block";
                }
            }
            
            // Batch processing functions
            function handleBatchFileSelect(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                
                // Check if all files are images
                for (let i = 0; i < files.length; i++) {
                    if (!files[i].type.match('image.*')) {
                        batchStatusMessage.textContent = "Please select only image files (JPEG, PNG, etc.)";
                        batchStatusMessage.className = "status-message status-error";
                        batchStatusMessage.style.display = "block";
                        return;
                    }
                }
                
                // Limit to 20 files for demo purposes
                if (files.length > 20) {
                    batchStatusMessage.textContent = "Maximum 20 files allowed for demo purposes";
                    batchStatusMessage.className = "status-message status-error";
                    batchStatusMessage.style.display = "block";
                    return;
                }
                
                batchFiles = Array.from(files);
                processBatchFiles();
            }
            
            function processBatchFiles() {
                batchUploadProgress.style.display = 'block';
                batchProgressBar.style.width = '0%';
                batchStatusMessage.style.display = 'none';
                batchResultsBody.innerHTML = '';
                exportBatchBtn.disabled = true;
                analyzeBatchBtn.disabled = true;
                
                let processedCount = 0;
                const totalFiles = batchFiles.length;
                
                batchFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        EXIF.getData(file, function() {
                            try {
                                const metadata = EXIF.getAllTags(this);
                                addBatchResult(file.name, metadata);
                                
                                processedCount++;
                                const progress = Math.round((processedCount / totalFiles) * 100);
                                batchProgressBar.style.width = `${progress}%`;
                                
                                if (processedCount === totalFiles) {
                                    batchUploadProgress.style.display = 'none';
                                    batchResults.classList.remove('hidden');
                                    batchStatusMessage.textContent = `Processed ${totalFiles} files successfully!`;
                                    batchStatusMessage.className = "status-message status-success";
                                    batchStatusMessage.style.display = "block";
                                    exportBatchBtn.disabled = false;
                                    analyzeBatchBtn.disabled = false;
                                }
                            } catch (e) {
                                console.error(`Error processing file ${file.name}:`, e);
                                addBatchResult(file.name, { error: "Error processing metadata" });
                                
                                processedCount++;
                                if (processedCount === totalFiles) {
                                    batchUploadProgress.style.display = 'none';
                                    batchResults.classList.remove('hidden');
                                    batchStatusMessage.textContent = `Processed ${totalFiles} files with some errors`;
                                    batchStatusMessage.className = "status-message status-error";
                                    batchStatusMessage.style.display = "block";
                                    exportBatchBtn.disabled = false;
                                    analyzeBatchBtn.disabled = false;
                                }
                            }
                        });
                    };
                    
                    reader.onerror = function() {
                        console.error(`Error reading file ${file.name}`);
                        addBatchResult(file.name, { error: "Error reading file" });
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            batchUploadProgress.style.display = 'none';
                            batchResults.classList.remove('hidden');
                            batchStatusMessage.textContent = `Processed ${totalFiles} files with some errors`;
                            batchStatusMessage.className = "status-message status-error";
                            batchStatusMessage.style.display = "block";
                            exportBatchBtn.disabled = false;
                            analyzeBatchBtn.disabled = false;
                        }
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            function addBatchResult(filename, metadata) {
                const row = document.createElement('tr');
                
                let camera = 'N/A';
                let date = 'N/A';
                let settings = 'N/A';
                let location = 'N/A';
                
                if (metadata.error) {
                    camera = metadata.error;
                } else {
                    camera = `${metadata.Make || ''} ${metadata.Model || ''}`.trim() || 'N/A';
                    date = metadata.DateTimeOriginal ? formatExifDate(metadata.DateTimeOriginal) : 'N/A';
                    
                    const settingsArr = [];
                    if (metadata.FNumber) settingsArr.push(`f/${metadata.FNumber}`);
                    if (metadata.ExposureTime) settingsArr.push(`${formatExposureTime(metadata.ExposureTime)}`);
                    if (metadata.ISOSpeedRatings) settingsArr.push(`ISO ${metadata.ISOSpeedRatings}`);
                    if (metadata.FocalLength) settingsArr.push(`${metadata.FocalLength}mm`);
                    
                    settings = settingsArr.join(', ') || 'N/A';
                    
                    if (metadata.GPSLatitude && metadata.GPSLongitude) {
                        location = `${convertGPSToDecimal(metadata.GPSLatitude, metadata.GPSLatitudeRef)}°, ${convertGPSToDecimal(metadata.GPSLongitude, metadata.GPSLongitudeRef)}°`;
                    } else {
                        location = 'N/A';
                    }
                }
                
                row.innerHTML = `
                    <td>${filename}</td>
                    <td>${camera}</td>
                    <td>${date}</td>
                    <td>${settings}</td>
                    <td>${location}</td>
                `;
                
                batchResultsBody.appendChild(row);
            }
            
            function showBatchStatistics() {
                batchChartContainer.classList.toggle('hidden');
                
                if (batchChartContainer.classList.contains('hidden')) {
                    analyzeBatchBtn.textContent = 'Show Statistics';
                    if (batchChart) {
                        batchChart.destroy();
                    }
                } else {
                    analyzeBatchBtn.textContent = 'Hide Statistics';
                    
                    try {
                        // Collect data for chart
                        const cameras = {};
                        const dates = {};
                        const isos = {};
                        
                        batchFiles.forEach(file => {
                            EXIF.getData(file, function() {
                                const metadata = EXIF.getAllTags(this);
                                
                                // Count cameras
                                const camera = `${metadata.Make || 'Unknown'} ${metadata.Model || ''}`.trim();
                                cameras[camera] = (cameras[camera] || 0) + 1;
                                
                                // Count by date
                                if (metadata.DateTimeOriginal) {
                                    const date = formatExifDate(metadata.DateTimeOriginal).split(' ')[0];
                                    dates[date] = (dates[date] || 0) + 1;
                                }
                                
                                // Count ISOs
                                const iso = metadata.ISOSpeedRatings || 'Unknown';
                                isos[iso] = (isos[iso] || 0) + 1;
                            });
                        });
                        
                        // Create chart data
                        const ctx = document.getElementById('batchChart').getContext('2d');
                        
                        if (batchChart) {
                            batchChart.destroy();
                        }
                        
                        batchChart = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: Object.keys(cameras),
                                datasets: [{
                                    label: 'Cameras Used',
                                    data: Object.values(cameras),
                                    backgroundColor: 'rgba(255, 215, 0, 0.7)',
                                    borderColor: 'rgba(255, 215, 0, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        ticks: {
                                            color: 'rgba(255, 255, 255, 0.8)'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    },
                                    x: {
                                        ticks: {
                                            color: 'rgba(255, 255, 255, 0.8)'
                                        },
                                        grid: {
                                            color: 'rgba(255, 255, 255, 0.1)'
                                        }
                                    }
                                },
                                plugins: {
                                    legend: {
                                        labels: {
                                            color: 'rgba(255, 255, 255, 0.8)'
                                        }
                                    }
                                }
                            }
                        });
                    } catch (e) {
                        console.error("Error creating batch chart:", e);
                    }
                }
            }
            
            function exportBatchMetadata() {
                if (batchFiles.length === 0) return;
                
                try {
                    let csvContent = "Filename,Camera Model,Date Taken,Aperture,Shutter Speed,ISO,Focal Length,Latitude,Longitude\n";
                    
                    let processed = 0;
                    const total = batchFiles.length;
                    
                    batchFiles.forEach(file => {
                        EXIF.getData(file, function() {
                            try {
                                const metadata = EXIF.getAllTags(this);
                                
                                const settings = {
                                    aperture: metadata.FNumber || 'N/A',
                                    shutterSpeed: metadata.ExposureTime ? formatExposureTime(metadata.ExposureTime) : 'N/A',
                                    iso: metadata.ISOSpeedRatings || 'N/A',
                                    focalLength: metadata.FocalLength || 'N/A'
                                };
                                
                                const location = {
                                    lat: metadata.GPSLatitude ? convertGPSToDecimal(metadata.GPSLatitude, metadata.GPSLatitudeRef) : 'N/A',
                                    lon: metadata.GPSLongitude ? convertGPSToDecimal(metadata.GPSLongitude, metadata.GPSLongitudeRef) : 'N/A'
                                };
                                
                                csvContent += `"${file.name}","${metadata.Make || ''} ${metadata.Model || ''}","${metadata.DateTimeOriginal ? formatExifDate(metadata.DateTimeOriginal) : 'N/A'}",${settings.aperture},${settings.shutterSpeed},${settings.iso},${settings.focalLength},${location.lat},${location.lon}\n`;
                            } catch (e) {
                                console.error(`Error processing file ${file.name} for export:`, e);
                                csvContent += `"${file.name}","Error","Error","Error","Error","Error","Error","Error","Error"\n`;
                            }
                            
                            processed++;
                            
                            if (processed === total) {
                                // Create download link
                                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = 'batch_metadata.csv';
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                
                                // Show success message
                                batchStatusMessage.textContent = "Batch metadata exported to CSV!";
                                batchStatusMessage.className = "status-message status-success";
                                batchStatusMessage.style.display = "block";
                            }
                        });
                    });
                } catch (e) {
                    console.error("Error exporting batch metadata:", e);
                    batchStatusMessage.textContent = "Error exporting batch metadata";
                    batchStatusMessage.className = "status-message status-error";
                    batchStatusMessage.style.display = "block";
                }
            }
            
            // Compare functions
            function handleCompareFileSelect(event) {
                const files = event.target.files;
                if (!files || files.length === 0) return;
                
                // Check if all files are images
                for (let i = 0; i < files.length; i++) {
                    if (!files[i].type.match('image.*')) {
                        compareStatusMessage.textContent = "Please select only image files (JPEG, PNG, etc.)";
                        compareStatusMessage.className = "status-message status-error";
                        compareStatusMessage.style.display = "block";
                        return;
                    }
                }
                
                // Limit to 4 files for comparison
                if (files.length < 2 || files.length > 4) {
                    compareStatusMessage.textContent = "Please select 2-4 images to compare";
                    compareStatusMessage.className = "status-message status-error";
                    compareStatusMessage.style.display = "block";
                    return;
                }
                
                compareFiles = Array.from(files);
                processCompareFiles();
            }
            
            function processCompareFiles() {
                compareUploadProgress.style.display = 'block';
                compareProgressBar.style.width = '0%';
                compareStatusMessage.style.display = 'none';
                compareOutput.innerHTML = '';
                exportCompareBtn.disabled = true;
                
                let processedCount = 0;
                const totalFiles = compareFiles.length;
                const allMetadata = [];
                
                compareFiles.forEach((file, index) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        EXIF.getData(file, function() {
                            try {
                                const metadata = EXIF.getAllTags(this);
                                allMetadata.push({
                                    file: file,
                                    metadata: metadata
                                });
                                
                                processedCount++;
                                const progress = Math.round((processedCount / totalFiles) * 100);
                                compareProgressBar.style.width = `${progress}%`;
                                
                                if (processedCount === totalFiles) {
                                    compareUploadProgress.style.display = 'none';
                                    compareResults.classList.remove('hidden');
                                    compareStatusMessage.textContent = `Comparison ready!`;
                                    compareStatusMessage.className = "status-message status-success";
                                    compareStatusMessage.style.display = "block";
                                    exportCompareBtn.disabled = false;
                                    
                                    displayComparison(allMetadata);
                                }
                            } catch (e) {
                                console.error(`Error processing file ${file.name} for comparison:`, e);
                                allMetadata.push({
                                    file: file,
                                    metadata: { error: "Error processing metadata" }
                                });
                                
                                processedCount++;
                                if (processedCount === totalFiles) {
                                    compareUploadProgress.style.display = 'none';
                                    compareResults.classList.remove('hidden');
                                    compareStatusMessage.textContent = `Comparison completed with some errors`;
                                    compareStatusMessage.className = "status-message status-error";
                                    compareStatusMessage.style.display = "block";
                                    exportCompareBtn.disabled = false;
                                    
                                    displayComparison(allMetadata);
                                }
                            }
                        });
                    };
                    
                    reader.onerror = function() {
                        console.error(`Error reading file ${file.name}`);
                        allMetadata.push({
                            file: file,
                            metadata: { error: "Error reading file" }
                        });
                        
                        processedCount++;
                        if (processedCount === totalFiles) {
                            compareUploadProgress.style.display = 'none';
                            compareResults.classList.remove('hidden');
                            compareStatusMessage.textContent = `Comparison completed with some errors`;
                            compareStatusMessage.className = "status-message status-error";
                            compareStatusMessage.style.display = "block";
                            exportCompareBtn.disabled = false;
                            
                            displayComparison(allMetadata);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                });
            }
            
            function displayComparison(metadataArray) {
                try {
                    // Create comparison chart
                    createComparisonChart(metadataArray);
                    
                    // Create comparison table
                    let html = '';
                    
                    // Camera Comparison Card
                    html += `
                        <div class="metadata-card">
                            <h3>Camera Comparison</h3>
                            ${metadataArray.map(item => `
                                <div class="metadata-item">
                                    <span class="metadata-label">${item.file.name}:</span>
                                    <span class="metadata-value">${item.metadata.error ? item.metadata.error : `${item.metadata.Make || 'Unknown'} ${item.metadata.Model || ''}`}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    // Settings Comparison Card
                    html += `
                        <div class="metadata-card">
                            <h3>Settings Comparison</h3>
                            <div class="metadata-item">
                                <span class="metadata-label">Aperture:</span>
                                <span class="metadata-value">${metadataArray.map(item => item.metadata.error ? 'Error' : (item.metadata.FNumber ? `f/${item.metadata.FNumber}` : 'N/A')).join(' vs ')}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Shutter Speed:</span>
                                <span class="metadata-value">${metadataArray.map(item => item.metadata.error ? 'Error' : (item.metadata.ExposureTime ? formatExposureTime(item.metadata.ExposureTime) : 'N/A')).join(' vs ')}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">ISO:</span>
                                <span class="metadata-value">${metadataArray.map(item => item.metadata.error ? 'Error' : (item.metadata.ISOSpeedRatings || 'N/A')).join(' vs ')}</span>
                            </div>
                            <div class="metadata-item">
                                <span class="metadata-label">Focal Length:</span>
                                <span class="metadata-value">${metadataArray.map(item => item.metadata.error ? 'Error' : (item.metadata.FocalLength ? `${item.metadata.FocalLength}mm` : 'N/A')).join(' vs ')}</span>
                            </div>
                        </div>
                    `;
                    
                    // Date & Location Comparison Card
                    let dateLocationHtml = '';
                    dateLocationHtml += `
                        <div class="metadata-item">
                            <span class="metadata-label">Date Taken:</span>
                            <span class="metadata-value">${metadataArray.map(item => item.metadata.error ? 'Error' : (item.metadata.DateTimeOriginal ? formatExifDate(item.metadata.DateTimeOriginal) : 'N/A')).join(' vs ')}</span>
                        </div>
                    `;
                    
                    if (metadataArray.some(item => !item.metadata.error && item.metadata.GPSLatitude)) {
                        dateLocationHtml += `
                            <div class="metadata-item">
                                <span class="metadata-label">Location:</span>
                                <span class="metadata-value">
                                    ${metadataArray.map(item => {
                                        if (item.metadata.error) return 'Error';
                                        if (item.metadata.GPSLatitude) {
                                            const lat = convertGPSToDecimal(item.metadata.GPSLatitude, item.metadata.GPSLatitudeRef);
                                            const lon = convertGPSToDecimal(item.metadata.GPSLongitude, item.metadata.GPSLongitudeRef);
                                            return `${lat}°, ${lon}°`;
                                        }
                                        return 'N/A';
                                    }).join(' vs ')}
                                </span>
                            </div>
                        `;
                    }
                    
                    html += `
                        <div class="metadata-card">
                            <h3>Date & Location Comparison</h3>
                            ${dateLocationHtml}
                        </div>
                    `;
                    
                    compareOutput.innerHTML = html;
                } catch (e) {
                    console.error("Error displaying comparison:", e);
                    compareOutput.innerHTML = '<div class="metadata-card"><h3>Error</h3><p>Could not display comparison results</p></div>';
                }
            }
            
            function createComparisonChart(metadataArray) {
                try {
                    const ctx = document.getElementById('compareChart').getContext('2d');
                    
                    if (compareChart) {
                        compareChart.destroy();
                    }
                    
                    const labels = metadataArray.map(item => item.file.name);
                    const apertureData = metadataArray.map(item => item.metadata.error ? 0 : (item.metadata.FNumber || 0));
                    const shutterData = metadataArray.map(item => item.metadata.error ? 0 : (item.metadata.ExposureTime ? 1/item.metadata.ExposureTime : 0));
                    const isoData = metadataArray.map(item => item.metadata.error ? 0 : (item.metadata.ISOSpeedRatings || 0));
                    const focalData = metadataArray.map(item => item.metadata.error ? 0 : (item.metadata.FocalLength || 0));
                    
                    compareChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Aperture (f/)',
                                    data: apertureData,
                                    backgroundColor: 'rgba(255, 215, 0, 0.7)',
                                    borderColor: 'rgba(255, 215, 0, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Shutter Speed (1/s)',
                                    data: shutterData,
                                    backgroundColor: 'rgba(255, 215, 0, 0.5)',
                                    borderColor: 'rgba(255, 215, 0, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'ISO',
                                    data: isoData,
                                    backgroundColor: 'rgba(255, 215, 0, 0.3)',
                                    borderColor: 'rgba(255, 215, 0, 1)',
                                    borderWidth: 1
                                },
                                {
                                    label: 'Focal Length (mm)',
                                    data: focalData,
                                    backgroundColor: 'rgba(255, 215, 0, 0.9)',
                                    borderColor: 'rgba(255, 215, 0, 1)',
                                    borderWidth: 1
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                },
                                x: {
                                    ticks: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    },
                                    grid: {
                                        color: 'rgba(255, 255, 255, 0.1)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: 'rgba(255, 255, 255, 0.8)'
                                    }
                                }
                            }
                        }
                    });
                } catch (e) {
                    console.error("Error creating comparison chart:", e);
                }
            }
            
            function exportComparison() {
                if (compareFiles.length === 0) return;
                
                try {
                    let csvContent = "Property," + compareFiles.map(file => file.name).join(',') + "\n";
                    
                    // Get all unique properties from all files
                    const allProperties = new Set();
                    compareFiles.forEach(file => {
                        EXIF.getData(file, function() {
                            const metadata = EXIF.getAllTags(this);
                            Object.keys(metadata).forEach(key => allProperties.add(key));
                        });
                    });
                    
                    // Add each property to CSV
                    Array.from(allProperties).forEach(prop => {
                        const row = [prop];
                        compareFiles.forEach(file => {
                            EXIF.getData(file, function() {
                                const metadata = EXIF.getAllTags(this);
                                row.push(metadata[prop] || '');
                            });
                        });
                        csvContent += row.join(',') + "\n";
                    });
                    
                    // Create download link
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'metadata_comparison.csv';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    // Show success message
                    compareStatusMessage.textContent = "Comparison exported to CSV!";
                    compareStatusMessage.className = "status-message status-success";
                    compareStatusMessage.style.display = "block";
                } catch (e) {
                    console.error("Error exporting comparison:", e);
                    compareStatusMessage.textContent = "Error exporting comparison";
                    compareStatusMessage.className = "status-message status-error";
                    compareStatusMessage.style.display = "block";
                }
            }
            
            // Tools functions
            function handleCleanerUpload() {
                const file = cleanerFileInput.files[0];
                if (!file) return;
                
                cleanerStatusMessage.textContent = "Processing image...";
                cleanerStatusMessage.className = "status-message";
                cleanerStatusMessage.style.display = "block";
                
                try {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        
                        // Create new file from canvas
                        canvas.toBlob(function(blob) {
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = file.name.replace(/\.[^/.]+$/, '') + '_clean.jpg';
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            URL.revokeObjectURL(url);
                            
                            // Show success message
                            cleanerStatusMessage.textContent = "Image cleaned and downloaded!";
                            cleanerStatusMessage.className = "status-message status-success";
                            cleanerStatusMessage.style.display = "block";
                        }, 'image/jpeg', 0.92);
                    };
                    
                    img.onerror = function() {
                        cleanerStatusMessage.textContent = "Error processing image";
                        cleanerStatusMessage.className = "status-message status-error";
                        cleanerStatusMessage.style.display = "block";
                    };
                    
                    img.src = URL.createObjectURL(file);
                } catch (e) {
                    console.error("Error in cleaner:", e);
                    cleanerStatusMessage.textContent = "Error processing image";
                    cleanerStatusMessage.className = "status-message status-error";
                    cleanerStatusMessage.style.display = "block";
                }
            }
            
            function handleGpsConversion() {
                const latInput = document.getElementById('gpsLat').value.trim();
                const lonInput = document.getElementById('gpsLon').value.trim();
                const format = document.getElementById('gpsFormat').value;
                
                if (!latInput || !lonInput) {
                    gpsResultValue.textContent = "Please enter both latitude and longitude";
                    gpsResult.classList.remove('hidden');
                    return;
                }
                
                const lat = parseFloat(latInput);
                const lon = parseFloat(lonInput);
                
                if (isNaN(lat) || isNaN(lon)) {
                    gpsResultValue.textContent = "Please enter valid coordinates";
                    gpsResult.classList.remove('hidden');
                    return;
                }
                
                try {
                    let result;
                    
                    switch (format) {
                        case 'dms':
                            result = convertDecimalToDMS(lat, lon);
                            break;
                        case 'utm':
                            result = "UTM conversion would go here (requires UTM library)";
                            break;
                        case 'decimal':
                        default:
                            result = `${lat.toFixed(6)}°, ${lon.toFixed(6)}°`;
                    }
                    
                    gpsResultValue.textContent = result;
                    gpsResult.classList.remove('hidden');
                } catch (e) {
                    console.error("Error in GPS conversion:", e);
                    gpsResultValue.textContent = "Error converting coordinates";
                    gpsResult.classList.remove('hidden');
                }
            }
            
            function convertDecimalToDMS(lat, lon) {
                const latDir = lat >= 0 ? 'N' : 'S';
                const lonDir = lon >= 0 ? 'E' : 'W';
                
                const absLat = Math.abs(lat);
                const absLon = Math.abs(lon);
                
                const latDeg = Math.floor(absLat);
                const latMin = Math.floor((absLat - latDeg) * 60);
                const latSec = ((absLat - latDeg - latMin/60) * 3600).toFixed(2);
                
                const lonDeg = Math.floor(absLon);
                const lonMin = Math.floor((absLon - lonDeg) * 60);
                const lonSec = ((absLon - lonDeg - lonMin/60) * 3600).toFixed(2);
                
                return `${latDeg}° ${latMin}' ${latSec}" ${latDir}, ${lonDeg}° ${lonMin}' ${lonSec}" ${lonDir}`;
            }
        });
    </script>
</body>
</html>